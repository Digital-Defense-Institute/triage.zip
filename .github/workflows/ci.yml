name: CI

permissions:
  contents: write

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 18 * * 1'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up JQ
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Check Velociraptor release version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          CURRENT_VERSION="unknown"
          if [ -f data/velociraptor-version.json ]; then
            CURRENT_VERSION=$(jq -r '.velociraptor_version // "unknown"' data/velociraptor-version.json)
          fi

          RESPONSE=$(curl -s -H "Accept: application/vnd.github+json" -H "Authorization: Bearer $GITHUB_TOKEN" https://api.github.com/repos/Velocidex/velociraptor/releases/latest)
          if [ -z "$RESPONSE" ]; then
            echo "Error: Unable to fetch Velociraptor release metadata" >&2
            exit 1
          fi

          ASSET_NAME=$(echo "$RESPONSE" | jq -r '[.assets[] | select(.name | test("velociraptor-.*-linux-amd64$")) | .name] | sort | last')
          UPSTREAM_VERSION=$(echo "$ASSET_NAME" | sed -n 's/.*velociraptor-v\([0-9.]*\)-linux-amd64$/\1/p')
          if [ -z "$UPSTREAM_VERSION" ]; then
            UPSTREAM_VERSION=$(echo "$RESPONSE" | jq -r '.tag_name' | sed 's/^v//')
          fi

          if [ -z "$UPSTREAM_VERSION" ] || [ "$UPSTREAM_VERSION" = "null" ]; then
            echo "Error: Unable to determine upstream Velociraptor version" >&2
            exit 1
          fi

          echo "Stored version: $CURRENT_VERSION"
          echo "Upstream version: $UPSTREAM_VERSION"
          echo "UPSTREAM_VELO_VERSION=$UPSTREAM_VERSION" >> $GITHUB_ENV

          if [ "$CURRENT_VERSION" = "$UPSTREAM_VERSION" ]; then
            echo "No new release detected."
            echo "VELO_VERSION_CHANGED=false" >> $GITHUB_ENV
          else
            echo "New release detected."
            echo "VELO_VERSION_CHANGED=true" >> $GITHUB_ENV
          fi

      - name: Check Windows.Triage.Targets version
        run: |
          set -euo pipefail

          # Fetch current ETag from HTTP header with retry logic
          MAX_RETRIES=3
          RETRY_DELAY=5
          CURRENT_ETAG=""

          for attempt in $(seq 1 $MAX_RETRIES); do
            echo "Fetching ETag (attempt $attempt of $MAX_RETRIES)..."
            HEADERS=$(curl -sI --fail --max-time 30 "https://triage.velocidex.com/artifacts/Windows.Triage.Targets.zip" 2>/dev/null || true)
            CURRENT_ETAG=$(echo "$HEADERS" | grep -i "^etag:" | tr -d '\r' | sed 's/^[Ee][Tt][Aa][Gg]: *//')

            if [ -n "$CURRENT_ETAG" ]; then
              break
            fi

            if [ "$attempt" -lt "$MAX_RETRIES" ]; then
              echo "No ETag received, retrying in ${RETRY_DELAY}s..."
              sleep $RETRY_DELAY
            fi
          done

          # Validate ETag was received
          if [ -z "$CURRENT_ETAG" ]; then
            echo "Error: No ETag header received from triage.velocidex.com after $MAX_RETRIES attempts" >&2
            echo "This may indicate a network issue or server misconfiguration." >&2
            exit 1
          fi

          # Load stored ETag
          STORED_ETAG="unknown"
          if [ -f data/velociraptor-version.json ]; then
            STORED_ETAG=$(jq -r '.triage_targets_etag // "unknown"' data/velociraptor-version.json)
          fi

          echo "Stored triage targets ETag: $STORED_ETAG"
          echo "Current triage targets ETag: $CURRENT_ETAG"

          # Use heredoc format to safely write ETag to env (prevents injection via malicious ETags)
          {
            echo "TRIAGE_ETAG<<EOF"
            echo "$CURRENT_ETAG"
            echo "EOF"
          } >> $GITHUB_ENV

          if [ "$STORED_ETAG" = "$CURRENT_ETAG" ]; then
            echo "Triage targets unchanged."
            echo "TRIAGE_TARGETS_CHANGED=false" >> $GITHUB_ENV
          else
            echo "Triage targets changed."
            echo "TRIAGE_TARGETS_CHANGED=true" >> $GITHUB_ENV
          fi

      - name: Run build script
        if: env.VELO_VERSION_CHANGED == 'true' || env.TRIAGE_TARGETS_CHANGED == 'true'
        env:
          SKIP_IF_VERSION_UNCHANGED: "1"
          TRIAGE_ETAG: ${{ env.TRIAGE_ETAG }}
          TRIAGE_TARGETS_CHANGED: ${{ env.TRIAGE_TARGETS_CHANGED }}
        run: bash build_collector.sh

      - name: Commit version metadata
        if: env.VELO_VERSION_CHANGED == 'true' || env.TRIAGE_TARGETS_CHANGED == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if git diff --quiet data/velociraptor-version.json; then
            echo "No version metadata changes to commit."
          else
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add data/velociraptor-version.json
            git commit -m "chore: update version metadata [skip ci]"
            git push
          fi

      - name: Delete existing latest release
        if: env.VELO_VERSION_CHANGED == 'true' || env.TRIAGE_TARGETS_CHANGED == 'true'
        run: |
          gh release delete latest --yes || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete old latest tag
        if: env.VELO_VERSION_CHANGED == 'true' || env.TRIAGE_TARGETS_CHANGED == 'true'
        run: |
          git tag -d latest || true
          git push --delete origin latest || true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


      - name: Create Latest Release
        if: env.VELO_VERSION_CHANGED == 'true' || env.TRIAGE_TARGETS_CHANGED == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create latest \
            ./datastore/Velociraptor_Triage_Collector.exe \
            --title "Latest Release" \
            --notes "Built with Velociraptor ${{ env.UPSTREAM_VELO_VERSION }}" \
            --latest
